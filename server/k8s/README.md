# running on Kubernetes

Introduction on how to run the news feed service in Kubernetes.

## minikube

For developer purposes, I am using [minikube](https://github.com/kubernetes/minikube) on a CentOS 7 laptop. The commands to start up minikube may be different for you.

```shell
minikube start --vm-driver=kvm2
eval $(minikube docker-env)
```

### setting up the dependencies

I have written some scripts and configuration files to get the dependent services running. The first script should work on any Kubernetes cluster and the second script is minikube specific. You will need to have installed minikube, kubectl, mysql and cqlsh and that they are available in your $PATH environment. You have to run that first scipt only once (unless you delete services and deployments). The second script will need to be run every time you start up minikube. You may need to wait a few minutes after starting minikube before you run that initMinikube.sh script.

```shell
cd clojure-news-feed/server/k8s
./setup.sh
./initMinikube.sh
```

### building the service

Right now, these assets are specific to the Node.js version of the news feed. That is because I could never get kafka to work in minikube and that is the only version that doesn't connect to Kafka anyway. Here is how to build a docker image for that version.

```shell
cd ../feed4
docker build -t feed4:1.0 .
```

### running the service

Note that the feed-deployment.yaml file is generated by the setup.sh script and deploys what we just built. 

```shell
cd ../k8s
kubectl create -f feed-service.yaml
kubectl create -f feed-deployment.yaml
```
### testing the service

This is also minikube specific.

```shell
FEED_URL=$(minikube service feed --url)

curl -H "Content-Type: application/json" -d '{"name":"testing dropwizard"}' ${FEED_URL}/participant/new

curl -H "Content-Type: application/json" -d '{"name":"testing minikube"}' ${FEED_URL}/participant/new

curl -H "Content-Type: application/json" -d '{"from":1,"to":2}' ${FEED_URL}/friends/new

curl -H "Content-Type: application/json" -d '{"from":1,"subject":"testing for dropwizard","story":"Kubernetes rocks!"}' ${FEED_URL}/outbound/new

curl ${FEED_URL}/inbound/2

curl -X POST -g "${FEED_URL}/outbound/search?keywords=kubernetes"
```
